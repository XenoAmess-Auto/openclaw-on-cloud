# 图片上传排查记录

## 问题描述
- **时间**: 2026-02-16
- **现象**: 用户上传图片后，OpenClaw 未收到图片内容
- **预期**: 图片应该作为多模态内容传递给 OpenClaw

## 相关历史修复

### 2025-01-21 图片附件传输修复
**问题**: OOC 平台无法发送图片附件到 OpenClaw  
**原因**:
1. `handleFileSelect` 和 `handlePaste` 在上传文件前先创建了本地 blob URL 作为预览
2. 发送消息时使用的是本地 blob URL (`blob:http://...`)，后端无法访问
3. `chat.ts` 的 `sendMessage` 将 blob URL 和 data URL 过滤为 null

**修复**:
- 文件选择上传：先调用 `fileApi.upload()`，使用返回的服务器 URL `/uploads/xxx.png`
- 粘贴上传：同样先上传再使用服务器 URL
- WebSocket 发送：过滤掉 `blob:` 和 `data:` 开头的无效 URL

**后端处理流程**:
1. `OpenClawPluginService.sendMessageStream()` 接收附件列表
2. 对于 `/uploads/` 开头的 URL，读取文件转为 base64 data URL
3. 对于 `data:` 开头的 URL，直接使用
4. 将图片作为多模态内容块 (`image_url`) 发送给 OpenClaw

## 排查步骤

### 1. 检查前端代码
- [ ] 确认 `HomeView.vue` 的 `handleFileSelect` 逻辑
- [ ] 确认 `handlePaste` 逻辑
- [ ] 确认 `chat.ts` 的 `sendMessage` 逻辑

### 2. 检查后端代码
- [ ] 确认 `ChatWebSocketHandler` 的图片处理
- [ ] 确认 `OpenClawPluginService.sendMessageStream()` 的多模态处理

### 3. 服务状态检查
- [ ] 后端服务是否运行
- [ ] 前端服务是否运行

### 4. 测试验证
- [ ] 上传图片并检查日志
- [ ] 验证图片是否到达 OpenClaw

## 排查结果

### 2026-02-16 自测发现

**服务状态**: 
- 后端服务运行正常 (PID 2388715，04:00 启动)
- 前端服务运行正常 (PID 2385363)
- uploads 目录存在且有文件
- 后端工作目录: `/home/xenoamess/.openclaw/workspace` ✓
- 日志位置: `/tmp/ooc-backend-latest.log`

**历史日志分析** (01:26 旧版本):
```
01:26:03  Message received: attachments=2
01:26:03  Attachment [0]: url=/uploads/4eebcac7-3e2c-4510-8f3e-9382c5e7c1e1.png
01:26:03  [sendMessageStream] Added image URL: http://localhost:8081/uploads/...
```
- 旧代码直接将 HTTP URL 发送给 OpenClaw，导致图片无法访问

**当前代码状态**:
- 源码已修复 (`28210c4` 及之后): 使用 `readFileToDataUrl()` 将图片转为 base64
- JAR 编译时间: 03:59 (包含修复)
- 服务启动时间: 04:00 (应该使用新代码)

**需要验证**:
- 当前运行的代码是否真的将图片转为 base64
- 用户现在上传图片是否能被 OpenClaw 正确处理

## 修复记录

### 2026-02-16 04:40 发现问题

日志显示：
```
Added image block, data URL length: 270038
```
文件读取成功！但 OpenClaw 报错：
```
invalid chat.send params: must have required property 'message'; 
at root: unexpected property 'content'
```

**根本原因**: OpenClaw WebSocket API 只接受 `message` 字符串参数，不支持 `content` 参数发送多模态内容。

### 2026-02-16 04:43 修复

**修复**: 修改 `OpenClawWebSocketClient.buildChatSendRequest()`
- 将多模态内容块转换为 markdown 格式字符串
- 图片以 `![image](data:image/...)` 格式嵌入 message

**部署**: 后端已重新编译并重启

### 2026-02-16 04:48 最终修复

**阅读 OpenClaw 原生代码后发现**:

OpenClaw `chat.send` 方法原生支持 `attachments` 参数，格式为：
```json
{
  "type": "image",
  "mimeType": "image/png",
  "fileName": "xxx.png", 
  "content": "base64编码的图片内容"
}
```

**修复**: 修改 `buildChatSendRequest()` 方法
- 使用 `attachments` 参数传递图片
- 图片 content 使用 base64 编码（不含 data URL 前缀）

**代码变更**: `OpenClawWebSocketClient.java`

**部署**: 后端已重新编译并重启 (04:48)

## 测试步骤

请现在再次尝试上传图片并 @openclaw。

